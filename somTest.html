<body onload="initApp();">

    <script>

        var playerLife = 50;
        var playerDeath = 0;

        var enemyLife = 5 + Math.floor(Math.random() * 10);
        var enemyDeath = 0;

        var GRID_WIDTH = 9;
        var GRID_HEIGHT = 9;

        function CellInfo() {
            this.isBomb = false;
            this.bombCount = 0;
            this.isVisible = false;
            this.isSelected = false;
        }

        function MapInfo() {
            this.bombCount = 10;
            this.availSelection = 3;
            this.cells = [];
        }

        MapInfo.prototype.init = function () {
            this.cells = [];

            for (var y = 0; y < GRID_HEIGHT; y++) {
                for (var x = 0; x < GRID_WIDTH; x++) {
                    this.cells[x + (y * GRID_WIDTH)] = new CellInfo();
                }
            }

            var curBomb = this.bombCount;

            while (curBomb > 0) {
                var x = Math.floor(Math.random() * GRID_WIDTH);
                var y = Math.floor(Math.random() * GRID_HEIGHT);

                if (!this.cells[x + (y * GRID_WIDTH)].isBomb) {
                    this.cells[x + (y * GRID_WIDTH)].isBomb = true;
                    curBomb--;

                    for (iy = -1; iy <= 1; iy++) {
                        for (ix = -1; ix <= 1; ix++) {
                            if (x + ix >= 0 && x + ix < GRID_WIDTH && y + iy >= 0 && y + iy < GRID_HEIGHT) {
                                this.cells[(x + ix) + ((y + iy) * GRID_WIDTH)].bombCount++;
                            }
                        }
                    }
                }
            }
        }

        MapInfo.prototype.selectCell = function (x, y) {
            this.cells[x + (y * GRID_WIDTH)].isSelected = true;
        }

        MapInfo.prototype.unselectCell = function (x, y) {
            this.cells[x + (y * GRID_WIDTH)].isSelected = false;
        }

        MapInfo.prototype.getSelectCellCount = function () {
            var ret = 0;

            for (var y = 0; y < GRID_HEIGHT; y++) {
                for (var x = 0; x < GRID_WIDTH; x++) {
                    if (this.cells[x + (y * GRID_WIDTH)].isSelected)
                        ret++;
                }
            }

            return ret;
        }

        MapInfo.prototype.isOver = function () {
            if (this.getFoundBomb() == this.bombCount)
                return true;
            return false;
        }

        MapInfo.prototype.handleSelect = function () {
            var found = false;

            do {
                found = false;

                for (var y = 0; y < GRID_HEIGHT; y++) {
                    for (var x = 0; x < GRID_WIDTH; x++) {
                        if (this.cells[x + (y * GRID_WIDTH)].isSelected) {
                            found = true;

                            this.cells[x + (y * GRID_WIDTH)].isSelected = false;
                            this.cells[x + (y * GRID_WIDTH)].isVisible = true;

                            if (this.cells[x + (y * GRID_WIDTH)].bombCount == 0) {

                                for (iy = -1; iy <= 1; iy++) {
                                    for (ix = -1; ix <= 1; ix++) {
                                        if (x + ix >= 0 && x + ix < GRID_WIDTH && y + iy >= 0 && y + iy < GRID_HEIGHT) {
                                            if (!this.cells[(x + ix) + ((y + iy) * GRID_WIDTH)].isVisible)
                                                this.cells[(x + ix) + ((y + iy) * GRID_WIDTH)].isSelected = true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } while (found);
        }

        MapInfo.prototype.getFoundBomb = function () {
            var ret = 0;

            for (var y = 0; y < GRID_HEIGHT; y++) {
                for (var x = 0; x < GRID_WIDTH; x++) {
                    if (this.cells[x + (y * GRID_WIDTH)].isVisible && this.cells[x + (y * GRID_WIDTH)].isBomb)
                        ret++;
                }
            }

            return ret;
        }

        //////////////////////////////////

        var map = new MapInfo();

        function initApp() {
            map.init();

            initCanvas();
            setInterval(handleBullets, 50);

            drawAll();
        }

        function cellClick(cx, cy) {
            if (!map.cells[cx + (cy * GRID_WIDTH)].isVisible) {
                document.getElementById("cell_" + cx + "_" + cy).classList.toggle('gameCellHighlight');

                if (document.getElementById("cell_" + cx + "_" + cy).classList.contains('gameCellHighlight')) {
                    map.selectCell(cx, cy);
                }
                else {
                    map.unselectCell(cx, cy);
                }

                verifyTurnEnd();
                drawAll();
            }
        }

        function verifyTurnEnd() {
            selectCount = map.getSelectCellCount();

            if (selectCount == map.availSelection) {
                var beforeBomb = map.getFoundBomb();

                for (var y = 0; y < GRID_HEIGHT; y++) {
                    for (var x = 0; x < GRID_WIDTH; x++) {
                        if (document.getElementById("cell_" + x + "_" + y).classList.contains('gameCellHighlight')) {
                            document.getElementById("cell_" + x + "_" + y).classList.toggle('gameCellHighlight');
                        }
                    }
                }

                map.handleSelect();

                var afterBomb = map.getFoundBomb();

                var hit = afterBomb - beforeBomb;

                var str = "Your ship hit the enemy for " + hit + " damage.\n";
                document.getElementById("message").value = str + document.getElementById("message").value;

                playerLife -= 1;
                enemyLife -= hit;

                addPlayerBullet(hit);
                addEnemyBullet(1);

                if (playerLife <= 0) {
                    playerLife = 50;
                    playerDeath++;
                }

                if (enemyLife <= 0) {
                    enemyLife = 5 + Math.floor(Math.random() * 10);
                    enemyDeath++;
                }

                if (map.isOver()) {
                    map.init();
                }
            }
        }

        function drawAll() {
            drawMap();
            document.getElementById("curSelectedCount").innerText = map.getSelectCellCount();
            document.getElementById("availSelect2").innerText = map.availSelection;

            document.getElementById("curBombFound").innerText = map.getFoundBomb();
            document.getElementById("curBombCount").innerText = map.bombCount;

            document.getElementById("playerLife").innerText = playerLife;
            document.getElementById("playerDeath").innerText = playerDeath;
            document.getElementById("enemyLife").innerText = enemyLife;
            document.getElementById("enemyDeath").innerText = enemyDeath;
        }

        function drawMap() {
            for (var y = 0; y < GRID_HEIGHT; y++) {
                for (var x = 0; x < GRID_WIDTH; x++) {
                    if (map.cells[x + (y * GRID_WIDTH)].isVisible) {
                        if (map.cells[x + (y * GRID_WIDTH)].isBomb) {
                            document.getElementById("cell_" + x + "_" + y).innerText = "X";
                        }
                        else {
                            document.getElementById("cell_" + x + "_" + y).innerText = map.cells[x + (y * GRID_WIDTH)].bombCount;
                        }
                    }
                    else {
                        document.getElementById("cell_" + x + "_" + y).innerText = "";
                    }
                }
            }
        }

        /////////////////////////////////////////////

        var canvas, ctx;
        var bullets = [];

        var EXPLOSION_DELAY = 10;

        function BulletInformation() {
            this.x = 0;
            this.y = 0;
            this.speed = 0;
            this.death = 0;
        }

        function addPlayerBullet(cnt) {
            for (var c = 0; c < cnt; c++) {
                for (var t = 0; t < 50; t++) {
                    if (bullets[t].death >= EXPLOSION_DELAY) {
                        bullets[t].x = 32;
                        bullets[t].y = Math.floor(Math.random() * 10) + 8;
                        bullets[t].speed = 15;
                        bullets[t].death = 0;
                        break;
                    }
                }
            }
        }

        function addEnemyBullet(cnt) {
            for (var c = 0; c < cnt; c++) {
                for (var t = 0; t < 50; t++) {
                    if (bullets[t].death >= EXPLOSION_DELAY) {
                        bullets[t].x = 150;
                        bullets[t].y = Math.floor(Math.random() * 10) + 8;
                        bullets[t].speed = -15;
                        bullets[t].death = 0;
                        break;
                    }
                }
            }
        }

        function handleBullets() {
            for (var t = 0; t < 50; t++) {
                if (bullets[t].death == 0) {
                    bullets[t].x += bullets[t].speed;

                    if (bullets[t].x < 32 || bullets[t].x > 150)
                        bullets[t].death = 1;
                }
                else if (bullets[t].death < EXPLOSION_DELAY) {
                    bullets[t].death++;
                }
            }
        }

        function initCanvas() {
            canvas = document.getElementById("mainCanvas");
            ctx = canvas.getContext("2d");

            for (var t = 0; t < 50; t++) {
                var b = new BulletInformation();
                b.death = EXPLOSION_DELAY;
                bullets.push(b);
            }

            requestAnimationFrame(drawCanvas);
        }

        function drawCanvas() {
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, 200, 50);

            ctx.drawImage(document.getElementById("ship1"), 10, 9);
            ctx.drawImage(document.getElementById("ship2"), 150, 9);

            for (var t = 0; t < 50; t++) {
                if (bullets[t].death == 0) {
                    if(bullets[t].speed > 0)
                        ctx.drawImage(document.getElementById("bullet1"), bullets[t].x, bullets[t].y);
                    else
                        ctx.drawImage(document.getElementById("bullet2"), bullets[t].x, bullets[t].y);
                }
                else if (bullets[t].death < EXPLOSION_DELAY) {
                    ctx.drawImage(document.getElementById("explosion"), bullets[t].x, bullets[t].y);
                }
            }

            requestAnimationFrame(drawCanvas);
        }

    </script>

    <style>

        .gameCell {
            width: 32px;
            height: 32px;
            border: 1px solid black;
            text-align: center;
        }

            .gameCell:hover {
                border: 1px solid #FF6666;
            }

        .gameCellHighlight {
            border: 1px solid red !important;
            background-color: #FFEEEE;
        }
    </style>

    <canvas id="mainCanvas" width="200" height="50" style="border: 1px solid black; width: 400px; height: 100px;"></canvas>

    <div style="display: none;">
        <img id="ship1" src="ship1.png" />
        <img id="ship2" src="ship2.png" />
        <img id="bullet1" src="bullet1.png" />
        <img id="bullet2" src="bullet2.png" />
        <img id="explosion" src="explosion.png" />
    </div>

    <table border="0" width="400">
        <tr>
            <td>
                <div>Player Life: <span id="playerLife"></span></div>
                <div>Player Death: <span id="playerDeath"></span></div>
            </td>
            <td>
                <div>Enemy Life: <span id="enemyLife"></span></div>
                <div>Enemy Death: <span id="enemyDeath"></span></div>
            </td>
        </tr>
    </table>

    <hr />

    <p>Need to mine mineral for our energy weapon. Select <span id="availSelect1"></span> cells, if you find minerals, you will hit the enemy.</p>

    <table>
        <tr>
            <td class="gameCell" id="cell_0_0" onclick="cellClick(0, 0);"></td>
            <td class="gameCell" id="cell_1_0" onclick="cellClick(1, 0);"></td>
            <td class="gameCell" id="cell_2_0" onclick="cellClick(2, 0);"></td>
            <td class="gameCell" id="cell_3_0" onclick="cellClick(3, 0);"></td>
            <td class="gameCell" id="cell_4_0" onclick="cellClick(4, 0);"></td>
            <td class="gameCell" id="cell_5_0" onclick="cellClick(5, 0);"></td>
            <td class="gameCell" id="cell_6_0" onclick="cellClick(6, 0);"></td>
            <td class="gameCell" id="cell_7_0" onclick="cellClick(7, 0);"></td>
            <td class="gameCell" id="cell_8_0" onclick="cellClick(8, 0);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_1" onclick="cellClick(0, 1);"></td>
            <td class="gameCell" id="cell_1_1" onclick="cellClick(1, 1);"></td>
            <td class="gameCell" id="cell_2_1" onclick="cellClick(2, 1);"></td>
            <td class="gameCell" id="cell_3_1" onclick="cellClick(3, 1);"></td>
            <td class="gameCell" id="cell_4_1" onclick="cellClick(4, 1);"></td>
            <td class="gameCell" id="cell_5_1" onclick="cellClick(5, 1);"></td>
            <td class="gameCell" id="cell_6_1" onclick="cellClick(6, 1);"></td>
            <td class="gameCell" id="cell_7_1" onclick="cellClick(7, 1);"></td>
            <td class="gameCell" id="cell_8_1" onclick="cellClick(8, 1);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_2" onclick="cellClick(0, 2);"></td>
            <td class="gameCell" id="cell_1_2" onclick="cellClick(1, 2);"></td>
            <td class="gameCell" id="cell_2_2" onclick="cellClick(2, 2);"></td>
            <td class="gameCell" id="cell_3_2" onclick="cellClick(3, 2);"></td>
            <td class="gameCell" id="cell_4_2" onclick="cellClick(4, 2);"></td>
            <td class="gameCell" id="cell_5_2" onclick="cellClick(5, 2);"></td>
            <td class="gameCell" id="cell_6_2" onclick="cellClick(6, 2);"></td>
            <td class="gameCell" id="cell_7_2" onclick="cellClick(7, 2);"></td>
            <td class="gameCell" id="cell_8_2" onclick="cellClick(8, 2);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_3" onclick="cellClick(0, 3);"></td>
            <td class="gameCell" id="cell_1_3" onclick="cellClick(1, 3);"></td>
            <td class="gameCell" id="cell_2_3" onclick="cellClick(2, 3);"></td>
            <td class="gameCell" id="cell_3_3" onclick="cellClick(3, 3);"></td>
            <td class="gameCell" id="cell_4_3" onclick="cellClick(4, 3);"></td>
            <td class="gameCell" id="cell_5_3" onclick="cellClick(5, 3);"></td>
            <td class="gameCell" id="cell_6_3" onclick="cellClick(6, 3);"></td>
            <td class="gameCell" id="cell_7_3" onclick="cellClick(7, 3);"></td>
            <td class="gameCell" id="cell_8_3" onclick="cellClick(8, 3);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_4" onclick="cellClick(0, 4);"></td>
            <td class="gameCell" id="cell_1_4" onclick="cellClick(1, 4);"></td>
            <td class="gameCell" id="cell_2_4" onclick="cellClick(2, 4);"></td>
            <td class="gameCell" id="cell_3_4" onclick="cellClick(3, 4);"></td>
            <td class="gameCell" id="cell_4_4" onclick="cellClick(4, 4);"></td>
            <td class="gameCell" id="cell_5_4" onclick="cellClick(5, 4);"></td>
            <td class="gameCell" id="cell_6_4" onclick="cellClick(6, 4);"></td>
            <td class="gameCell" id="cell_7_4" onclick="cellClick(7, 4);"></td>
            <td class="gameCell" id="cell_8_4" onclick="cellClick(8, 4);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_5" onclick="cellClick(0, 5);"></td>
            <td class="gameCell" id="cell_1_5" onclick="cellClick(1, 5);"></td>
            <td class="gameCell" id="cell_2_5" onclick="cellClick(2, 5);"></td>
            <td class="gameCell" id="cell_3_5" onclick="cellClick(3, 5);"></td>
            <td class="gameCell" id="cell_4_5" onclick="cellClick(4, 5);"></td>
            <td class="gameCell" id="cell_5_5" onclick="cellClick(5, 5);"></td>
            <td class="gameCell" id="cell_6_5" onclick="cellClick(6, 5);"></td>
            <td class="gameCell" id="cell_7_5" onclick="cellClick(7, 5);"></td>
            <td class="gameCell" id="cell_8_5" onclick="cellClick(8, 5);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_6" onclick="cellClick(0, 6);"></td>
            <td class="gameCell" id="cell_1_6" onclick="cellClick(1, 6);"></td>
            <td class="gameCell" id="cell_2_6" onclick="cellClick(2, 6);"></td>
            <td class="gameCell" id="cell_3_6" onclick="cellClick(3, 6);"></td>
            <td class="gameCell" id="cell_4_6" onclick="cellClick(4, 6);"></td>
            <td class="gameCell" id="cell_5_6" onclick="cellClick(5, 6);"></td>
            <td class="gameCell" id="cell_6_6" onclick="cellClick(6, 6);"></td>
            <td class="gameCell" id="cell_7_6" onclick="cellClick(7, 6);"></td>
            <td class="gameCell" id="cell_8_6" onclick="cellClick(8, 6);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_7" onclick="cellClick(0, 7);"></td>
            <td class="gameCell" id="cell_1_7" onclick="cellClick(1, 7);"></td>
            <td class="gameCell" id="cell_2_7" onclick="cellClick(2, 7);"></td>
            <td class="gameCell" id="cell_3_7" onclick="cellClick(3, 7);"></td>
            <td class="gameCell" id="cell_4_7" onclick="cellClick(4, 7);"></td>
            <td class="gameCell" id="cell_5_7" onclick="cellClick(5, 7);"></td>
            <td class="gameCell" id="cell_6_7" onclick="cellClick(6, 7);"></td>
            <td class="gameCell" id="cell_7_7" onclick="cellClick(7, 7);"></td>
            <td class="gameCell" id="cell_8_7" onclick="cellClick(8, 7);"></td>
        </tr>
        <tr>
            <td class="gameCell" id="cell_0_8" onclick="cellClick(0, 8);"></td>
            <td class="gameCell" id="cell_1_8" onclick="cellClick(1, 8);"></td>
            <td class="gameCell" id="cell_2_8" onclick="cellClick(2, 8);"></td>
            <td class="gameCell" id="cell_3_8" onclick="cellClick(3, 8);"></td>
            <td class="gameCell" id="cell_4_8" onclick="cellClick(4, 8);"></td>
            <td class="gameCell" id="cell_5_8" onclick="cellClick(5, 8);"></td>
            <td class="gameCell" id="cell_6_8" onclick="cellClick(6, 8);"></td>
            <td class="gameCell" id="cell_7_8" onclick="cellClick(7, 8);"></td>
            <td class="gameCell" id="cell_8_8" onclick="cellClick(8, 8);"></td>
        </tr>
    </table>

    <div>Selection: <span id="curSelectedCount"></span> / <span id="availSelect2"></span></div>
    <div>Minerals Found: <span id="curBombFound"></span> / <span id="curBombCount"></span></div>

    <hr />

    <textarea id="message" style="width: 400px; height: 100px;"></textarea>

</body>